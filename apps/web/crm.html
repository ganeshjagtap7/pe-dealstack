<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Deals - PE OS</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#003366",
                        "primary-hover": "#002855",
                        "primary-light": "#E6EEF5",
                        "secondary": "#059669",
                        "secondary-light": "#D1FAE5",
                        "background-body": "#F8F9FA",
                        "surface-card": "#FFFFFF",
                        "border-subtle": "#E5E7EB",
                        "border-focus": "#CBD5E1",
                        "text-main": "#111827",
                        "text-secondary": "#4B5563",
                        "text-muted": "#9CA3AF",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"],
                        "display": ["Inter", "sans-serif"],
                    },
                    boxShadow: {
                        "card": "0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05)",
                        "card-hover": "0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05)",
                        "glow": "0 0 15px rgba(0, 51, 102, 0.1)",
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "md": "0.375rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                    }
                },
            },
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        body {
            font-feature-settings: "cv11", "ss01";
            -webkit-font-smoothing: antialiased;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-background-body text-text-main font-sans overflow-hidden">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar (injected by layout.js) -->
        <div id="sidebar-root"></div>

        <!-- Main Content -->
        <main class="flex h-full flex-1 flex-col overflow-hidden bg-background-body">
            <!-- Header -->
            <header class="flex h-16 shrink-0 items-center justify-between border-b border-border-subtle px-6 bg-surface-card z-10 sticky top-0">
                <div class="flex items-center gap-4 flex-1">
                    <button class="md:hidden text-text-main" id="mobile-menu-btn">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <div class="relative hidden w-full max-w-lg md:block group">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <span class="material-symbols-outlined text-text-muted group-focus-within:text-primary transition-colors text-[20px]">search</span>
                        </div>
                        <input
                            id="search-input"
                            class="block w-full rounded-md border border-border-subtle bg-background-body py-2 pl-10 pr-10 text-sm text-text-main placeholder-text-muted focus:ring-1 focus:ring-primary focus:border-primary transition-all shadow-sm"
                            placeholder="Search deals by name, industry, or thesis..."
                            type="text"
                        />
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                            <kbd class="hidden sm:inline-block rounded px-2 py-0.5 text-[10px] font-bold text-text-muted bg-gray-100 border border-border-subtle">CMD+K</kbd>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="ingest-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg shadow-sm hover:bg-primary-hover transition-colors text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                        Ingest Deal Data
                    </button>
                    <button class="flex items-center justify-center rounded-lg p-2 text-text-secondary hover:text-primary hover:bg-primary-light transition-colors relative" id="notifications-btn">
                        <span class="material-symbols-outlined text-[20px]">notifications</span>
                        <span class="absolute top-2 right-2 h-2 w-2 rounded-full bg-red-500 border border-white"></span>
                    </button>
                    <div class="h-6 w-px bg-border-subtle"></div>
                    <button class="flex items-center gap-2 text-sm font-medium text-text-main hover:text-primary transition-colors" id="user-menu-btn">
                        <div class="bg-center bg-no-repeat bg-cover rounded-full size-8 border border-gray-200 shadow-sm" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDztZZcBzY1SDBiF6rrZUV2Uq3M3sq3RNYyna4KXazODqpygVamoT478nqKsofGUiklF7LO4vfeblawPKJND10QK_mGWph7pQy_KzS-ARWQcZhjgKy925pPcsmKqIfnvj0-wNcUIwMIkWVQBCow5BMpnm3C0q_hFoQSgJ5r5aNZit5hjEU9gA0GFz7UQvGfnIwMVEl_mnRGag2umDcEHXDI8dLtE0WeR46Q64G6mwDZu99lbfgscGOi36kf77BFEZOeFx1nCs8uuGk');"></div>
                        <span class="hidden md:inline">Alex Morgan</span>
                        <span class="material-symbols-outlined text-[18px] text-text-muted">expand_more</span>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="mx-auto max-w-[1600px] flex flex-col gap-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex flex-col gap-1">
                            <h1 class="text-2xl font-bold text-text-main tracking-tight font-display">Deal Pipeline</h1>
                            <p id="deal-count" class="text-text-secondary text-sm flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-secondary shadow-[0_0_8px_rgba(5,150,105,0.4)]"></span>
                                Loading...
                            </p>
                        </div>
                    </div>

                    <!-- Filters Row -->
                    <div class="flex flex-wrap gap-3 items-center">
                        <div class="relative">
                            <button id="stage-filter-btn" class="flex h-9 shrink-0 items-center gap-2 rounded-lg bg-surface-card border border-border-subtle px-3.5 hover:border-primary/30 hover:shadow-sm transition-all group">
                                <p id="stage-filter-text" class="text-text-secondary group-hover:text-text-main text-sm font-medium">Stage: All</p>
                                <span class="material-symbols-outlined text-text-muted text-[16px]">keyboard_arrow_down</span>
                            </button>
                            <div id="stage-dropdown" class="hidden absolute top-full left-0 mt-2 bg-surface-card border border-border-subtle rounded-lg shadow-lg z-50 min-w-[180px] py-1">
                                <button data-stage="" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light font-medium">All Stages</button>
                                <button data-stage="INITIAL_REVIEW" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Initial Review</button>
                                <button data-stage="DUE_DILIGENCE" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Due Diligence</button>
                                <button data-stage="IOI_SUBMITTED" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">IOI Submitted</button>
                                <button data-stage="LOI_SUBMITTED" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">LOI Submitted</button>
                                <button data-stage="NEGOTIATION" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Negotiation</button>
                                <button data-stage="CLOSING" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Closing</button>
                                <button data-stage="PASSED" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Passed</button>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="industry-filter-btn" class="flex h-9 shrink-0 items-center gap-2 rounded-lg bg-surface-card border border-border-subtle px-3.5 hover:border-primary/30 hover:shadow-sm transition-all group">
                                <p id="industry-filter-text" class="text-text-secondary group-hover:text-text-main text-sm font-medium">Industry: All</p>
                                <span class="material-symbols-outlined text-text-muted text-[16px]">keyboard_arrow_down</span>
                            </button>
                            <div id="industry-dropdown" class="hidden absolute top-full left-0 mt-2 bg-surface-card border border-border-subtle rounded-lg shadow-lg z-50 min-w-[180px] py-1">
                                <button data-industry="" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light font-medium">All Industries</button>
                                <button data-industry="SaaS" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">SaaS</button>
                                <button data-industry="Healthcare" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Healthcare</button>
                                <button data-industry="Cloud" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Cloud Infrastructure</button>
                                <button data-industry="Transportation" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Transportation</button>
                                <button data-industry="Fintech" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Fintech</button>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="dealsize-filter-btn" class="flex h-9 shrink-0 items-center gap-2 rounded-lg bg-surface-card border border-border-subtle px-3.5 hover:border-primary/30 hover:shadow-sm transition-all group">
                                <p id="dealsize-filter-text" class="text-text-secondary group-hover:text-text-main text-sm font-medium">Deal Size: All</p>
                                <span class="material-symbols-outlined text-text-muted text-[16px]">keyboard_arrow_down</span>
                            </button>
                            <div id="dealsize-dropdown" class="hidden absolute top-full left-0 mt-2 bg-surface-card border border-border-subtle rounded-lg shadow-lg z-50 min-w-[180px] py-1">
                                <button data-min="" data-max="" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light font-medium">All Sizes</button>
                                <button data-min="0" data-max="10" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Under $10M</button>
                                <button data-min="10" data-max="50" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">$10M - $50M</button>
                                <button data-min="50" data-max="100" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">$50M - $100M</button>
                                <button data-min="100" data-max="" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Over $100M</button>
                            </div>
                        </div>
                        <div class="h-6 w-px bg-border-subtle mx-1 hidden sm:block"></div>
                        <div class="relative">
                            <button id="sort-btn" class="flex h-9 shrink-0 items-center gap-2 rounded-lg px-3 hover:bg-primary-light transition-all">
                                <span class="material-symbols-outlined text-text-muted text-[18px]">sort</span>
                                <p id="sort-text" class="text-text-secondary text-sm font-medium">Sort by: Recent</p>
                            </button>
                            <div id="sort-dropdown" class="hidden absolute top-full right-0 mt-2 bg-surface-card border border-border-subtle rounded-lg shadow-lg z-50 min-w-[160px] py-1">
                                <button data-sort="updatedAt" data-order="desc" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light font-medium">Recent Activity</button>
                                <button data-sort="dealSize" data-order="desc" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Deal Size (High)</button>
                                <button data-sort="dealSize" data-order="asc" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Deal Size (Low)</button>
                                <button data-sort="irrProjected" data-order="desc" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">IRR (High)</button>
                                <button data-sort="name" data-order="asc" class="w-full text-left px-4 py-2 text-sm hover:bg-primary-light">Name (A-Z)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Deals Grid -->
                    <div id="deals-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-5 pb-6">
                        <!-- Loading state -->
                        <div id="loading-state" class="col-span-full flex flex-col items-center justify-center py-20">
                            <span class="material-symbols-outlined text-primary text-4xl animate-spin mb-4">sync</span>
                            <p class="text-text-muted text-sm font-medium">Loading deals...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<!-- Load shared layout and auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/auth.js"></script>
<script src="js/layout.js"></script>
<script>
const API_BASE_URL = 'http://localhost:3001/api';

// Current filter/sort state
let filters = {
    stage: '',
    industry: '',
    minDealSize: '',
    maxDealSize: '',
    search: '',
    sortBy: 'updatedAt',
    sortOrder: 'desc'
};

// Stage badge styles
const stageStyles = {
    'INITIAL_REVIEW': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', label: 'Initial Review' },
    'DUE_DILIGENCE': { bg: 'bg-primary-light', border: 'border-primary/20', text: 'text-primary', label: 'Due Diligence' },
    'IOI_SUBMITTED': { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', label: 'IOI Submitted' },
    'LOI_SUBMITTED': { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', label: 'LOI Submitted' },
    'NEGOTIATION': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', label: 'Negotiation' },
    'CLOSING': { bg: 'bg-teal-50', border: 'border-teal-200', text: 'text-teal-700', label: 'Closing' },
    'PASSED': { bg: 'bg-gray-100', border: 'border-gray-300', text: 'text-gray-600', label: 'Passed' },
    'CLOSED_WON': { bg: 'bg-secondary-light', border: 'border-secondary/20', text: 'text-secondary', label: 'Closed Won' },
    'CLOSED_LOST': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', label: 'Closed Lost' }
};

// Format currency
function formatCurrency(value) {
    if (value === null || value === undefined) return 'N/A';
    const absValue = Math.abs(value);
    if (absValue >= 1000) return `$${(value / 1000).toFixed(1)}B`;
    if (absValue >= 1) return `$${value.toFixed(1)}M`;
    return `$${(value * 1000).toFixed(0)}K`;
}

// Format relative time
function formatRelativeTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(hours / 24);
    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    return 'Just now';
}

// Get document icon
function getDocIcon(docName) {
    if (!docName) return 'description';
    const ext = docName.split('.').pop()?.toLowerCase();
    if (ext === 'pdf') return 'picture_as_pdf';
    if (ext === 'xlsx' || ext === 'xls') return 'table_chart';
    if (ext === 'msg' || ext === 'eml') return 'mail';
    return 'description';
}

// Render a deal card
function renderDealCard(deal) {
    const style = stageStyles[deal.stage] || stageStyles['INITIAL_REVIEW'];
    const isPassed = deal.status === 'PASSED' || deal.stage === 'PASSED';
    const momColor = deal.mom >= 3 ? 'text-secondary' : 'text-text-main';
    const ebitdaColor = deal.ebitda < 0 ? 'text-red-600' : 'text-text-main';
    const hasRiskFlag = deal.ebitda < 0 || deal.stage === 'PASSED';

    return `
        <a href="deal.html?id=${deal.id}" class="block group">
            <article class="bg-surface-card rounded-lg border border-border-subtle p-5 hover:border-primary/30 transition-all cursor-pointer flex flex-col h-full shadow-card hover:shadow-card-hover relative overflow-hidden ${isPassed ? 'opacity-70 hover:opacity-100' : ''}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex gap-3 items-center">
                        <div class="size-10 rounded-lg bg-primary-light border border-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-[20px]">${deal.icon || 'business_center'}</span>
                        </div>
                        <div>
                            <h3 class="text-text-main font-bold text-base leading-tight group-hover:text-primary transition-colors">${deal.name}</h3>
                            <p class="text-text-muted text-xs font-medium">${deal.industry || 'N/A'}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 rounded-md ${style.bg} border ${style.border} ${style.text} text-[10px] font-bold uppercase tracking-wider">${style.label}</span>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-background-body rounded-md p-3">
                        <span class="text-text-muted text-[10px] font-bold uppercase tracking-wider block mb-1">IRR (Proj)</span>
                        <span class="text-text-main font-bold text-lg">${deal.irrProjected ? deal.irrProjected.toFixed(1) + '%' : 'N/A'}</span>
                    </div>
                    <div class="bg-background-body rounded-md p-3">
                        <span class="text-text-muted text-[10px] font-bold uppercase tracking-wider block mb-1">MoM</span>
                        <span class="${momColor} font-bold text-lg">${deal.mom ? deal.mom.toFixed(1) + 'x' : 'N/A'}</span>
                    </div>
                    <div class="bg-background-body rounded-md p-3">
                        <span class="text-text-muted text-[10px] font-bold uppercase tracking-wider block mb-1">EBITDA</span>
                        <span class="${ebitdaColor} font-bold text-lg">${formatCurrency(deal.ebitda)}</span>
                    </div>
                    <div class="bg-background-body rounded-md p-3">
                        <span class="text-text-muted text-[10px] font-bold uppercase tracking-wider block mb-1">Revenue</span>
                        <span class="text-text-main font-bold text-lg">${formatCurrency(deal.revenue)}</span>
                    </div>
                </div>
                <div class="bg-background-body rounded-md p-3 mt-auto border border-border-subtle">
                    <div class="flex items-center gap-2 mb-1.5">
                        <span class="material-symbols-outlined ${hasRiskFlag ? 'text-red-500' : 'text-secondary'} text-[14px]">${hasRiskFlag ? 'warning' : 'auto_awesome'}</span>
                        <span class="${hasRiskFlag ? 'text-red-500' : 'text-secondary'} text-[10px] font-bold uppercase tracking-wider">${hasRiskFlag ? 'Risk Flag' : 'AI Thesis'}</span>
                    </div>
                    <p class="text-text-secondary text-xs leading-relaxed line-clamp-2">${deal.aiThesis || 'No AI analysis available yet.'}</p>
                </div>
                <div class="flex items-center justify-between mt-4 pt-3 border-t border-border-subtle">
                    <div class="flex items-center gap-1.5 text-text-muted">
                        <span class="material-symbols-outlined text-[14px]">${getDocIcon(deal.lastDocument)}</span>
                        <span class="text-[11px] font-medium truncate max-w-[120px]">${deal.lastDocument || 'No docs'}</span>
                    </div>
                    <span class="text-[11px] text-text-muted font-medium">${formatRelativeTime(deal.lastDocumentUpdated || deal.updatedAt)}</span>
                </div>
            </article>
        </a>
    `;
}

// Render upload card
function renderUploadCard() {
    return `
        <article id="upload-card" class="bg-surface-card/50 rounded-lg border-2 border-dashed border-border-subtle p-5 hover:border-primary hover:bg-primary-light/30 transition-all cursor-pointer group flex flex-col items-center justify-center h-full min-h-[320px] text-center gap-4">
            <div class="size-14 rounded-full bg-surface-card border border-border-subtle flex items-center justify-center group-hover:scale-110 group-hover:border-primary/30 transition-all shadow-sm">
                <span class="material-symbols-outlined text-text-muted group-hover:text-primary text-2xl">add</span>
            </div>
            <div>
                <h3 class="text-text-main font-bold text-base group-hover:text-primary transition-colors">Upload Documents</h3>
                <p class="text-text-muted text-sm mt-1 max-w-[180px]">Drop CIMs, Teasers, or Excel models</p>
            </div>
        </article>
    `;
}

// Render error state
function renderError(message) {
    return `
        <div class="col-span-full flex flex-col items-center justify-center py-20">
            <span class="material-symbols-outlined text-red-500 text-4xl mb-4">error</span>
            <p class="text-text-main font-medium mb-2">Failed to load deals</p>
            <p class="text-text-muted text-sm mb-4">${message}</p>
            <button onclick="loadDeals()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-hover transition-colors">
                Try Again
            </button>
        </div>
    `;
}

// Render empty state
function renderEmpty() {
    return `
        <div class="col-span-full flex flex-col items-center justify-center py-20">
            <span class="material-symbols-outlined text-text-muted text-4xl mb-4">search_off</span>
            <p class="text-text-main font-medium mb-2">No deals found</p>
            <p class="text-text-muted text-sm">Try adjusting your filters or search query</p>
        </div>
        ${renderUploadCard()}
    `;
}

// Build query string from filters
function buildQueryString() {
    const params = new URLSearchParams();
    if (filters.stage) params.set('stage', filters.stage);
    if (filters.industry) params.set('industry', filters.industry);
    if (filters.minDealSize) params.set('minDealSize', filters.minDealSize);
    if (filters.maxDealSize) params.set('maxDealSize', filters.maxDealSize);
    if (filters.search) params.set('search', filters.search);
    if (filters.sortBy) params.set('sortBy', filters.sortBy);
    if (filters.sortOrder) params.set('sortOrder', filters.sortOrder);
    return params.toString();
}

// Load deals from API
async function loadDeals() {
    const grid = document.getElementById('deals-grid');
    grid.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-20">
            <span class="material-symbols-outlined text-primary text-4xl animate-spin mb-4">sync</span>
            <p class="text-text-muted text-sm font-medium">Loading deals...</p>
        </div>
    `;

    try {
        const queryString = buildQueryString();
        const response = await PEAuth.authFetch(`${API_BASE_URL}/deals?${queryString}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const deals = await response.json();

        // Update deal count
        const activeDeals = deals.filter(d => d.status !== 'PASSED').length;
        document.getElementById('deal-count').innerHTML = `
            <span class="w-2 h-2 rounded-full bg-secondary shadow-[0_0_8px_rgba(5,150,105,0.4)]"></span>
            ${activeDeals} Active Opportunities
        `;

        if (deals.length === 0) {
            grid.innerHTML = renderEmpty();
            return;
        }

        // Render deal cards
        grid.innerHTML = deals.map(deal => renderDealCard(deal)).join('') + renderUploadCard();

    } catch (error) {
        console.error('Error loading deals:', error);
        grid.innerHTML = renderError(error.message);
    }
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize dropdowns and event listeners
function initializeFilters() {
    // Toggle dropdown visibility
    function toggleDropdown(btnId, dropdownId) {
        const btn = document.getElementById(btnId);
        const dropdown = document.getElementById(dropdownId);

        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            // Close all other dropdowns
            document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
                if (d.id !== dropdownId) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        });
    }

    // Stage filter
    toggleDropdown('stage-filter-btn', 'stage-dropdown');
    document.querySelectorAll('#stage-dropdown button').forEach(btn => {
        btn.addEventListener('click', () => {
            filters.stage = btn.dataset.stage;
            document.getElementById('stage-filter-text').textContent = filters.stage
                ? `Stage: ${stageStyles[filters.stage]?.label || filters.stage}`
                : 'Stage: All';
            document.getElementById('stage-dropdown').classList.add('hidden');
            loadDeals();
        });
    });

    // Industry filter
    toggleDropdown('industry-filter-btn', 'industry-dropdown');
    document.querySelectorAll('#industry-dropdown button').forEach(btn => {
        btn.addEventListener('click', () => {
            filters.industry = btn.dataset.industry;
            document.getElementById('industry-filter-text').textContent = filters.industry
                ? `Industry: ${filters.industry}`
                : 'Industry: All';
            document.getElementById('industry-dropdown').classList.add('hidden');
            loadDeals();
        });
    });

    // Deal size filter
    toggleDropdown('dealsize-filter-btn', 'dealsize-dropdown');
    document.querySelectorAll('#dealsize-dropdown button').forEach(btn => {
        btn.addEventListener('click', () => {
            filters.minDealSize = btn.dataset.min;
            filters.maxDealSize = btn.dataset.max;
            let text = 'Deal Size: All';
            if (btn.dataset.min && btn.dataset.max) {
                text = `Deal Size: $${btn.dataset.min}M - $${btn.dataset.max}M`;
            } else if (btn.dataset.min) {
                text = `Deal Size: > $${btn.dataset.min}M`;
            } else if (btn.dataset.max) {
                text = `Deal Size: < $${btn.dataset.max}M`;
            }
            document.getElementById('dealsize-filter-text').textContent = text;
            document.getElementById('dealsize-dropdown').classList.add('hidden');
            loadDeals();
        });
    });

    // Sort
    toggleDropdown('sort-btn', 'sort-dropdown');
    document.querySelectorAll('#sort-dropdown button').forEach(btn => {
        btn.addEventListener('click', () => {
            filters.sortBy = btn.dataset.sort;
            filters.sortOrder = btn.dataset.order;
            document.getElementById('sort-text').textContent = `Sort by: ${btn.textContent.trim()}`;
            document.getElementById('sort-dropdown').classList.add('hidden');
            loadDeals();
        });
    });

    // Search input with debounce
    const searchInput = document.getElementById('search-input');
    const debouncedSearch = debounce(() => {
        filters.search = searchInput.value;
        loadDeals();
    }, 300);
    searchInput.addEventListener('input', debouncedSearch);

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
        document.querySelectorAll('[id$="-dropdown"]').forEach(d => d.classList.add('hidden'));
    });
}

// Upload modal functionality
function initializeUploadModal() {
    // Create modal if it doesn't exist
    if (!document.getElementById('upload-modal')) {
        const modal = document.createElement('div');
        modal.id = 'upload-modal';
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-surface-card rounded-xl shadow-2xl max-w-lg w-full p-6 relative animate-[slideIn_0.2s_ease-out]">
                <button id="close-upload-modal" class="absolute top-4 right-4 text-text-muted hover:text-text-main transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <div class="text-center mb-6">
                    <div class="size-16 rounded-full bg-primary-light flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-primary text-3xl">smart_toy</span>
                    </div>
                    <h3 class="text-xl font-bold text-text-main">Ingest Deal Data</h3>
                    <p class="text-text-secondary text-sm mt-1">Upload a CIM or Teaser PDF - AI will extract data and create the deal automatically</p>
                </div>
                <div id="drop-zone" class="border-2 border-dashed border-border-subtle rounded-xl p-8 text-center hover:border-primary hover:bg-primary-light/30 transition-all cursor-pointer">
                    <input type="file" id="file-input" class="hidden" accept=".pdf" />
                    <span class="material-symbols-outlined text-text-muted text-4xl mb-3">cloud_upload</span>
                    <p class="text-text-main font-medium">Drag & drop files here</p>
                    <p class="text-text-muted text-sm mt-1">or click to browse</p>
                    <p class="text-text-muted text-xs mt-3">Supported: PDF (CIM, Teaser, Financials)</p>
                </div>
                <div id="upload-progress" class="hidden mt-4">
                    <div class="flex items-center gap-3 p-3 bg-background-body rounded-lg">
                        <span class="material-symbols-outlined text-primary animate-spin">sync</span>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-text-main">Uploading...</p>
                            <div class="h-1.5 bg-border-subtle rounded-full mt-1.5 overflow-hidden">
                                <div id="progress-bar" class="h-full bg-primary rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="upload-success" class="hidden mt-4">
                    <div class="flex items-center gap-3 p-3 bg-secondary-light rounded-lg border border-secondary/20">
                        <span class="material-symbols-outlined text-secondary">check_circle</span>
                        <p class="text-sm font-medium text-secondary">File uploaded successfully!</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Close modal handler
        document.getElementById('close-upload-modal').addEventListener('click', closeUploadModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeUploadModal();
        });

        // Drop zone handlers
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-primary-light/30');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary', 'bg-primary-light/30');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-primary-light/30');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', function(e) {
            console.log('File input changed, files:', this.files);
            if (this.files && this.files.length > 0) {
                handleFiles(this.files);
                // Reset input so the same file can be selected again
                setTimeout(() => { this.value = ''; }, 100);
            }
        });
    }

    // Ingest Deal Data button
    const ingestBtn = document.getElementById('ingest-btn');
    if (ingestBtn) {
        ingestBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openUploadModal();
        });
    }
}

function openUploadModal() {
    const modal = document.getElementById('upload-modal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeUploadModal() {
    const modal = document.getElementById('upload-modal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    // Reset state
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('upload-success').classList.add('hidden');
    document.getElementById('drop-zone').classList.remove('hidden');
}

async function handleFiles(files) {
    console.log('handleFiles called with', files.length, 'files');
    if (files.length === 0) return;

    // Only support one file at a time for auto-deal creation
    const file = files[0];

    if (file.type !== 'application/pdf') {
        showNotification('Error', 'Please upload a PDF file for auto-deal creation', 'error');
        return;
    }

    const dropZone = document.getElementById('drop-zone');
    const progressDiv = document.getElementById('upload-progress');
    const successDiv = document.getElementById('upload-success');
    const progressBar = document.getElementById('progress-bar');

    dropZone.classList.add('hidden');
    progressDiv.classList.remove('hidden');

    // Update progress text to show AI is processing
    const progressText = progressDiv.querySelector('p.text-sm');
    if (progressText) {
        progressText.textContent = 'Extracting text & analyzing with AI...';
    }

    try {
        const formData = new FormData();
        formData.append('file', file);
        console.log('Ingesting file:', file.name);

        // Animate progress slowly since AI takes time
        progressBar.style.width = '30%';

        const response = await PEAuth.authFetch(`${API_BASE_URL}/ingest`, {
            method: 'POST',
            body: formData,
        });
        console.log('Ingest response status:', response.status);

        progressBar.style.width = '80%';

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Ingest failed');
        }

        const result = await response.json();
        console.log('Ingest result:', result);
        progressBar.style.width = '100%';

        progressDiv.classList.add('hidden');
        successDiv.classList.remove('hidden');

        // Update success message with deal info
        const successText = successDiv.querySelector('p');
        if (successText && result.deal) {
            successText.textContent = `Deal "${result.deal.name}" created!`;
        }

        setTimeout(() => {
            closeUploadModal();
            const industry = result.extractedData?.industry || 'Unknown';
            const revenue = result.extractedData?.revenue ? `$${result.extractedData.revenue}M revenue` : '';
            showNotification('Deal Created',
                `"${result.deal.name}" - ${industry}${revenue ? ', ' + revenue : ''}`,
                'success'
            );
            loadDeals(); // Refresh the deals list
        }, 1500);

    } catch (error) {
        console.error('Ingest error:', error);
        progressDiv.classList.add('hidden');
        dropZone.classList.remove('hidden');
        showNotification('Error', `Failed to process: ${error.message}`, 'error');
    }
}

function showNotification(title, message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-secondary' : type === 'error' ? 'bg-red-500' : 'bg-primary';
    notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 animate-[slideIn_0.3s_ease-out]`;
    notification.innerHTML = `
        <span class="material-symbols-outlined text-white">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
        <div>
            <p class="font-bold text-sm">${title}</p>
            <p class="text-sm opacity-90">${message}</p>
        </div>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 4000);
}

// Initialize upload card click handler
function initializeUploadCard() {
    document.addEventListener('click', (e) => {
        if (e.target.closest('#upload-card')) {
            openUploadModal();
        }
    });
}

// Keyboard shortcuts
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // CMD+K to focus search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
        // Escape to close modal
        if (e.key === 'Escape') {
            closeUploadModal();
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication - redirect to login if not authenticated
    await PEAuth.initSupabase();
    const auth = await PEAuth.checkAuth();
    if (!auth) return; // checkAuth redirects to login

    // Initialize shared layout with collapsible sidebar
    PELayout.init('deals', { collapsible: true });

    initializeFilters();
    loadDeals();
    initializeUploadModal();
    initializeUploadCard();
    initializeKeyboardShortcuts();
});
</script>
</body>
</html>
