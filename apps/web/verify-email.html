<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Email Verified - PE OS</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#003366",
                        "primary-hover": "#002855",
                        "background-light": "#f6f7f8",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        @keyframes checkmark {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-checkmark {
            animation: checkmark 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-background-light min-h-screen flex flex-col font-display text-[#111418]">
    <!-- Header -->
    <header class="w-full border-b border-gray-200 bg-white sticky top-0 z-50">
        <div class="max-w-[1280px] mx-auto px-6 h-16 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-3 cursor-pointer select-none">
                <div class="size-8 rounded bg-primary/10 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-2xl">bar_chart</span>
                </div>
                <h2 class="text-xl font-bold leading-tight tracking-tight">PE OS</h2>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col items-center justify-center px-4 py-12">
        <!-- Success State -->
        <div id="successState" class="w-full max-w-[440px] bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <!-- Success Icon -->
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center animate-checkmark">
                    <span class="material-symbols-outlined text-green-600 text-4xl">check_circle</span>
                </div>
            </div>

            <!-- Success Message -->
            <h1 class="text-2xl font-bold text-[#111418] mb-2">Email Verified!</h1>
            <p class="text-gray-500 text-sm mb-6">
                Your email has been successfully verified. You can now sign in to your account.
            </p>

            <!-- Action Button -->
            <a
                href="login.html"
                class="inline-flex items-center justify-center gap-2 w-full bg-primary hover:bg-primary-hover text-white font-medium rounded-lg h-12 transition-all duration-200"
            >
                <span>Continue to Login</span>
                <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
            </a>

            <!-- Auto redirect notice -->
            <p id="redirectNotice" class="text-xs text-gray-400 mt-4">
                Redirecting to login in <span id="countdown">5</span> seconds...
            </p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden w-full max-w-[440px] bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <!-- Error Icon -->
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-600 text-4xl">error</span>
                </div>
            </div>

            <!-- Error Message -->
            <h1 class="text-2xl font-bold text-[#111418] mb-2">Verification Failed</h1>
            <p id="errorMessage" class="text-gray-500 text-sm mb-4">
                This verification link is invalid or has expired.
            </p>

            <!-- Resend Email Form -->
            <div id="resendForm" class="mb-4">
                <p class="text-gray-600 text-sm mb-3">Enter your email to receive a new verification link:</p>
                <div class="flex gap-2">
                    <input
                        type="email"
                        id="resendEmail"
                        placeholder="your@email.com"
                        class="flex-1 rounded-lg border border-gray-200 px-4 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none"
                    />
                    <button
                        id="resendBtn"
                        onclick="resendVerification()"
                        class="bg-primary hover:bg-primary-hover text-white font-medium rounded-lg px-4 py-2 text-sm transition-all duration-200 disabled:opacity-50"
                    >
                        Resend
                    </button>
                </div>
                <p id="resendMessage" class="text-sm mt-2 hidden"></p>
            </div>

            <!-- Divider -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-200"></div>
                </div>
                <div class="relative flex justify-center text-xs">
                    <span class="bg-white px-2 text-gray-400">or</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-3">
                <a
                    href="signup.html"
                    class="inline-flex items-center justify-center gap-2 w-full bg-white hover:bg-gray-50 text-[#111418] border border-gray-200 font-medium rounded-lg h-12 transition-all duration-200"
                >
                    <span>Sign Up Again</span>
                </a>
                <a
                    href="login.html"
                    class="inline-flex items-center justify-center gap-2 w-full bg-white hover:bg-gray-50 text-[#111418] border border-gray-200 font-medium rounded-lg h-12 transition-all duration-200"
                >
                    <span>Go to Login</span>
                </a>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden w-full max-w-[440px] bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center">
                    <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-xl font-medium text-[#111418]">Verifying your email...</h1>
        </div>
    </main>

    <!-- Footer -->
    <footer class="w-full py-6 text-center text-xs text-gray-400">
        Â© 2026 PE OS. All rights reserved.
    </footer>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- Auth Helper -->
    <script src="js/auth.js"></script>

    <script>
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');
        const loadingState = document.getElementById('loadingState');
        const errorMessage = document.getElementById('errorMessage');
        const countdown = document.getElementById('countdown');

        // Auto-redirect countdown
        let countdownValue = 5;
        let countdownInterval;

        function startCountdown() {
            countdownInterval = setInterval(() => {
                countdownValue--;
                countdown.textContent = countdownValue;
                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'login.html';
                }
            }, 1000);
        }

        function showSuccess() {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            successState.classList.remove('hidden');
            startCountdown();
        }

        function showError(message) {
            loadingState.classList.add('hidden');
            successState.classList.add('hidden');
            errorState.classList.remove('hidden');
            if (message) {
                errorMessage.textContent = message;
            }
        }

        // Resend verification email
        async function resendVerification() {
            const emailInput = document.getElementById('resendEmail');
            const resendBtn = document.getElementById('resendBtn');
            const resendMessage = document.getElementById('resendMessage');
            const email = emailInput.value.trim();

            if (!email) {
                resendMessage.textContent = 'Please enter your email address.';
                resendMessage.className = 'text-sm mt-2 text-red-500';
                resendMessage.classList.remove('hidden');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                resendMessage.textContent = 'Please enter a valid email address.';
                resendMessage.className = 'text-sm mt-2 text-red-500';
                resendMessage.classList.remove('hidden');
                return;
            }

            // Show loading state
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            resendMessage.classList.add('hidden');

            try {
                const { error } = await PEAuth.resendVerificationEmail(email);

                if (error) {
                    resendMessage.textContent = error.message || 'Failed to send verification email.';
                    resendMessage.className = 'text-sm mt-2 text-red-500';
                } else {
                    resendMessage.textContent = 'Verification email sent! Check your inbox.';
                    resendMessage.className = 'text-sm mt-2 text-green-600';
                    emailInput.value = '';
                }
                resendMessage.classList.remove('hidden');
            } catch (err) {
                resendMessage.textContent = 'An error occurred. Please try again.';
                resendMessage.className = 'text-sm mt-2 text-red-500';
                resendMessage.classList.remove('hidden');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend';
            }
        }

        // Check verification status on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading state initially
            successState.classList.add('hidden');
            errorState.classList.add('hidden');
            loadingState.classList.remove('hidden');

            try {
                const client = await PEAuth.initSupabase();

                // Check for errors in URL (hash or query params)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const queryParams = new URLSearchParams(window.location.search);

                const error = hashParams.get('error') || queryParams.get('error');
                const errorDescription = hashParams.get('error_description') || queryParams.get('error_description');

                if (error) {
                    showError(errorDescription || 'Email verification failed. Please try again.');
                    return;
                }

                // Check for token_hash (email verification link format)
                const tokenHash = queryParams.get('token_hash');
                const type = queryParams.get('type');

                if (tokenHash && type === 'email') {
                    // Verify the OTP token
                    const { data, error: verifyError } = await client.auth.verifyOtp({
                        token_hash: tokenHash,
                        type: 'email',
                    });

                    if (verifyError) {
                        console.error('Verification error:', verifyError);
                        showError(verifyError.message || 'Email verification failed. The link may have expired.');
                        return;
                    }

                    if (data.user) {
                        showSuccess();
                        return;
                    }
                }

                // Check for access_token in hash (implicit flow)
                const accessToken = hashParams.get('access_token');
                if (accessToken) {
                    // Token is automatically handled by Supabase client
                    // Wait a moment for the session to be established
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Check current user status
                const { user, session } = await PEAuth.getUser();

                if (user && user.email_confirmed_at) {
                    showSuccess();
                } else if (user) {
                    // User exists but email not confirmed
                    showError('Email verification is still pending. Please check your inbox.');
                } else {
                    // No user and no tokens - invalid link
                    showError('This verification link is invalid or has expired.');
                }

            } catch (error) {
                console.error('Verification error:', error);
                showError('An error occurred during verification. Please try again.');
            }
        });
    </script>
</body>
</html>
