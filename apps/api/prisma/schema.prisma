// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum DealStage {
  INITIAL_REVIEW
  DUE_DILIGENCE
  IOI_SUBMITTED
  LOI_SUBMITTED
  NEGOTIATION
  CLOSING
  PASSED
  CLOSED_WON
  CLOSED_LOST
}

enum DealStatus {
  ACTIVE
  PROCESSING
  PASSED
  ARCHIVED
}

enum DocumentType {
  CIM
  TEASER
  FINANCIALS
  LEGAL
  NDA
  LOI
  EMAIL
  OTHER
}

enum ActivityType {
  DOCUMENT_UPLOADED
  STAGE_CHANGED
  NOTE_ADDED
  MEETING_SCHEDULED
  CALL_LOGGED
  EMAIL_SENT
  STATUS_UPDATED
}

model Company {
  id          String   @id @default(cuid())
  name        String
  industry    String?
  description String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deals       Deal[]

  @@index([name])
}

model Deal {
  id              String     @id @default(cuid())
  name            String
  companyId       String
  stage           DealStage  @default(INITIAL_REVIEW)
  status          DealStatus @default(ACTIVE)

  // Financial metrics
  irrProjected    Float?
  mom             Float?
  ebitda          Float?
  revenue         Float?

  // Deal details
  industry        String?
  dealSize        Float?
  description     String?
  aiThesis        String?

  // Metadata
  icon            String?    @default("business_center")
  lastDocument    String?
  lastDocumentUpdated DateTime?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  company              Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents            Document[]
  activities           Activity[]
  memos                Memo[]
  financialStatements  FinancialStatement[]

  @@index([companyId])
  @@index([stage])
  @@index([status])
  @@index([updatedAt])
}

model Document {
  id          String       @id @default(cuid())
  dealId      String
  name        String
  type        DocumentType @default(OTHER)
  fileUrl     String?
  fileSize    Int?
  mimeType    String?

  // AI extracted data
  extractedData Json?
  confidence    Float?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  deal                Deal                 @relation(fields: [dealId], references: [id], onDelete: Cascade)
  financialStatements FinancialStatement[]

  @@index([dealId])
  @@index([type])
}

model Activity {
  id          String       @id @default(cuid())
  dealId      String
  type        ActivityType
  title       String
  description String?
  metadata    Json?

  createdAt   DateTime     @default(now())

  deal        Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([createdAt])
}

// Investment Memo Related Models

enum MemoType {
  IC_MEMO
  TEASER
  SUMMARY
  CUSTOM
}

enum MemoStatus {
  DRAFT
  REVIEW
  FINAL
  ARCHIVED
}

enum MemoSectionType {
  EXECUTIVE_SUMMARY
  COMPANY_OVERVIEW
  FINANCIAL_PERFORMANCE
  MARKET_DYNAMICS
  COMPETITIVE_LANDSCAPE
  RISK_ASSESSMENT
  DEAL_STRUCTURE
  VALUE_CREATION
  EXIT_STRATEGY
  RECOMMENDATION
  APPENDIX
  CUSTOM
}

model Memo {
  id            String      @id @default(uuid())
  title         String
  projectName   String?
  dealId        String?
  type          MemoType    @default(IC_MEMO)
  status        MemoStatus  @default(DRAFT)
  sponsor       String?
  memoDate      DateTime?

  createdBy     String?
  lastEditedBy  String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  deal          Deal?       @relation(fields: [dealId], references: [id], onDelete: SetNull)
  sections      MemoSection[]
  conversations MemoConversation[]

  @@index([dealId])
  @@index([status])
  @@index([updatedAt])
}

model MemoSection {
  id          String          @id @default(uuid())
  memoId      String
  type        MemoSectionType
  title       String
  content     String?
  sortOrder   Int             @default(0)

  // AI metadata
  aiGenerated Boolean         @default(false)
  aiModel     String?
  aiPrompt    String?

  // Rich content
  tableData   Json?
  chartConfig Json?
  citations   Json?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  memo        Memo            @relation(fields: [memoId], references: [id], onDelete: Cascade)

  @@index([memoId])
  @@index([sortOrder])
}

model MemoConversation {
  id        String    @id @default(uuid())
  memoId    String
  userId    String?
  title     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  memo      Memo      @relation(fields: [memoId], references: [id], onDelete: Cascade)
  messages  MemoChatMessage[]

  @@index([memoId])
  @@index([userId])
}

model MemoChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  role           String           // 'user' or 'assistant'
  content        String
  metadata       Json?

  createdAt      DateTime         @default(now())

  conversation   MemoConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// Chat messages for deal conversations (existing feature)
model ChatMessage {
  id        String    @id @default(uuid())
  dealId    String?
  userId    String?
  role      String    // 'user' or 'assistant'
  content   String
  metadata  Json?

  createdAt DateTime  @default(now())

  @@index([dealId])
  @@index([createdAt])
}

// ─── Financial Statement Extraction ──────────────────────────
// Stores full 3-statement model extracted from CIMs/financials
// lineItems is JSONB: { "revenue": 12.5, "ebitda": 3.2, ... }
// One row per (dealId, statementType, period) — upsertable

model FinancialStatement {
  id         String   @id @default(uuid())

  // Foreign keys
  dealId     String
  documentId String?  // Which document this was extracted from

  // Classification
  statementType String // INCOME_STATEMENT | BALANCE_SHEET | CASH_FLOW
  period        String // "2021", "2022", "LTM", "2025E"
  periodType    String @default("HISTORICAL") // HISTORICAL | PROJECTED | LTM

  // Extracted data
  lineItems Json   @default("{}") // All line items as JSONB
  currency  String @default("USD")
  unitScale String @default("MILLIONS") // MILLIONS | THOUSANDS | ACTUALS

  // Extraction metadata
  extractionConfidence Int     @default(0)   // 0-100
  extractionSource     String? @default("gpt4o") // gpt4o | azure | vision | manual
  extractedAt          DateTime?

  // Human review
  reviewedAt DateTime?
  reviewedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deal     Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@unique([dealId, statementType, period])
  @@index([dealId])
  @@index([dealId, statementType])
}
